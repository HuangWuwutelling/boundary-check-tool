# 边界文件检查工具 - 完整使用说明

## 📋 目录
- [工具简介](#工具简介)
- [功能特点](#功能特点)
- [环境要求](#环境要求)
- [安装指南](#安装指南)
- [使用方法](#使用方法)
- [文件格式要求](#文件格式要求)
- [结果说明](#结果说明)
- [常见问题](#常见问题)
- [制作EXE文件](#制作exe文件)
- [联系方式](#联系方式)

## 🔧 工具简介

边界文件检查工具是一个专门用于批量检查地块边界文件规范性的Python工具。它能够自动验证SHP文件的完整性、字段规范性、坐标系正确性，并生成详细的检查报告和可视化地图。

### 主要解决的问题
- ✅ 批量检查大量边界文件的规范性
- ✅ 自动验证地块位置与边界的空间关系
- ✅ 智能处理中文编码和坐标系转换问题
- ✅ 生成标准化的检查报告和统计信息

## 🚀 功能特点

### 核心功能
1. **文件完整性检查**
   - CPG编码文件检查
   - SHP文件组完整性验证
   - PRJ坐标系文件检查

2. **数据规范性验证**
   - 必要字段完整性检查
   - 字段内容非空验证
   - 几何类型正确性检查

3. **空间位置校验**
   - 地块坐标点与边界范围匹配
   - 自动计算正确的中心点坐标
   - 坐标系智能转换

4. **结果输出**
   - Excel详细检查报告
   - 交互式HTML地图
   - 控制台统计信息

### 技术特色
- 🔍 **智能编码检测**: 自动识别GBK/UTF-8编码
- 🗺️ **坐标系自适应**: 支持地理和投影坐标系转换
- 🔧 **中文路径支持**: 完美处理中文文件名
- ⚡ **批量处理**: 支持数百个文件同时处理
- 🛡️ **错误恢复**: 单个文件错误不影响整体处理

## 💻 环境要求

### Python版本
- Python 3.7 或更高版本

### 必需依赖库
```
geopandas >= 0.14.0    # 地理数据处理
pandas >= 2.0.3        # 数据分析
folium >= 0.14.0       # 地图可视化
shapely >= 2.0.1       # 几何计算
chardet >= 5.2.0       # 编码检测
openpyxl >= 3.1.2      # Excel文件处理
pyproj >= 3.6.1        # 坐标系转换
fiona >= 1.9.5         # 地理文件读取
```

### 系统要求
- **操作系统**: Windows 7/10/11, macOS, Linux
- **内存**: 建议4GB以上
- **磁盘空间**: 至少1GB可用空间

## 📦 安装指南

### 方法一：使用Conda（推荐）
```bash
# 创建新环境
conda create -n boundary_check python=3.9

# 激活环境
conda activate boundary_check

# 安装依赖
conda install -c conda-forge geopandas pandas folium openpyxl chardet

# 安装其他依赖
pip install pyshp
```

### 方法二：使用pip
```bash
# 安装核心依赖（可能需要额外配置GDAL）
pip install -r requirements.txt

# Windows用户如遇到问题，可尝试：
pip install pipwin
pipwin install gdal
pipwin install fiona
pip install geopandas
```

### 方法三：使用EXE文件（无需Python环境）
- 直接下载编译好的exe文件
- 双击运行，无需安装任何依赖

## 📝 使用方法

### 1. 准备数据文件

#### 文件结构示例
```
工作目录/
├── 地块信息.xlsx                    # 必需：地块信息表
├── 初步调查4420013990012.zip        # 边界文件ZIP包
├── 详细调查4451023990064.zip        # 边界文件ZIP包
├── 初步调查4451032590001.zip        # 更多ZIP文件...
└── ...
```

### 2. 运行程序

#### Python环境运行
```bash
python 边界文件检测工具V3.py
```

#### EXE文件运行
双击 `边界文件检查工具.exe`

### 3. 选择工作目录

程序启动后会弹出选择框：
- **选择文件位置**: 通过文件浏览器选择目录
- **输入文件地址**: 手动输入目录路径

选择包含"地块信息.xlsx"和所有ZIP文件的目录。

### 4. 查看结果

程序运行完成后会生成：
- **检查结果窗口**: 显示详细检查结果表格
- **Excel报告**: 工作目录下的"地块信息.xlsx"新增"result"和"统计信息"工作表
- **HTML地图**: "地块边界检查结果.html"交互式地图

## 📄 文件格式要求

### Excel文件格式（地块信息.xlsx）

#### 必需列
| 列名 | 数据类型 | 说明 | 示例 |
|------|----------|------|------|
| 地块编码 | 文本 | 13位数字编码 | 4420013990012 |
| 经度 | 数值 | 地块中心点经度 | 113.2644 |
| 纬度 | 数值 | 地块中心点纬度 | 23.1291 |

#### 可选列
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| 地块名称 | 文本 | 地块描述信息 |
| 行政区代码 | 文本 | 行政区划代码 |
| 行政区名称 | 文本 | 行政区划名称 |

#### 示例数据
```
地块编码        地块名称         经度        纬度
4420013990012  某某地块一期     113.2644    23.1291
4451023990064  某某地块二期     113.3644    23.2291
4451032590001  某某工业地块     113.4644    23.3291
```

### ZIP文件要求

#### 命名规范
- **格式**: `{前缀}{13位地块编码}.zip`
- **示例**: 
  - ✅ `初步调查4420013990012.zip`
  - ✅ `详细调查4451023990064.zip`
  - ✅ `补充调查4451032590001.zip`
  - ❌ `地块442001399001.zip` (缺少13位编码)
  - ❌ `调查报告.zip` (无地块编码)

#### SHP文件组要求
每个ZIP文件内必须包含完整的SHP文件组：

| 文件扩展名 | 是否必需 | 说明 |
|------------|----------|------|
| .shp | ✅ 必需 | 主文件，存储几何数据 |
| .shx | ✅ 必需 | 索引文件 |
| .dbf | ✅ 必需 | 属性表文件 |
| .prj | ✅ 必需 | 坐标系文件 |
| .cpg | 🔶 推荐 | 编码文件（解决中文乱码） |
| .sbn/.sbx | ⭕ 可选 | 空间索引文件 |

#### SHP属性字段要求

##### 必需字段（支持中英文）
| 中文字段名 | 英文字段名 | 数据类型 | 说明 |
|------------|------------|----------|------|
| 地块名称 | DKMC/dkmc | 文本 | 地块名称信息 |
| 地块代码 | DKDM/DKBM/dkdm/dkbm | 文本 | 地块编码 |
| 行政区代码 | XZQDM/xzqdm | 文本 | 行政区划代码 |
| 行政区名称 | XZQMC/xzqmc | 文本 | 行政区划名称 |
| 地块面积 | YDMJ/ydmj | 数值 | 地块面积（平方米） |

##### 几何类型要求
- ✅ **Polygon**: 面状几何（推荐）
- ✅ **MultiPolygon**: 多面几何（支持）
- ❌ **Point**: 点几何（不支持，需转换）
- ❌ **LineString**: 线几何（不支持，需转换）

### 坐标系要求

#### 支持的坐标系
- **地理坐标系**: WGS84 (EPSG:4326), CGCS2000 (EPSG:4490)
- **投影坐标系**: 各种UTM投影、高斯投影等

#### 坐标系检查
- 工具会自动检查.prj文件
- 地理坐标系会给出警告（建议使用投影坐标系）
- 自动进行坐标系转换进行空间位置验证

## 📊 结果说明

### Excel检查报告

#### "result"工作表字段说明
| 字段名 | 说明 |
|--------|------|
| zip_file_name | ZIP文件名 |
| shp_file_relative | SHP文件在ZIP中的相对路径 |
| 地块编码 | 提取的13位地块编码 |
| 地块名称 | 来自Excel的地块名称 |
| 经度/纬度 | 来自Excel的坐标信息 |
| cpg | CPG文件检查结果 |
| polygon | 几何类型检查结果 |
| field | 必要字段检查结果 |
| field_content | 字段内容检查结果 |
| crs | 坐标系信息 |
| In_polygon | 点是否在多边形内 |
| 经度new/纬度new | 修正后的坐标（如适用） |
| result | 综合检查结果 |

#### "统计信息"工作表
- 总体统计数据
- 各类问题数量统计
- 通过率统计

### 检查结果状态

#### 通过状态
- **pass**: 所有检查项都通过

#### 常见问题状态
- **地块信息中未找到该地块编码**: ZIP文件名中的地块编码在Excel中不存在
- **cpg文件缺失**: 缺少编码文件，可能导致中文乱码
- **字段缺失**: SHP文件缺少必要的属性字段
- **字段内容为空**: 必要字段存在但内容为空
- **几何类型错误**: SHP文件几何类型不是面（Polygon）
- **坐标系文件缺失**: 缺少.prj坐标系文件
- **地理坐标系**: 使用地理坐标系（建议使用投影坐标系）
- **地块位置不在边界范围内**: 地块中心点不在边界多边形内

### HTML地图说明

#### 地图功能
- **底图**: 卫星影像底图
- **图层控制**: 可以开关不同ZIP文件的显示
- **交互式**: 点击边界查看详细信息
- **标记点**: 显示地块中心点位置
- **弹出信息**: 显示详细的属性信息

#### 使用方法
1. 用浏览器打开"地块边界检查结果.html"
2. 使用鼠标滚轮缩放地图
3. 点击边界查看详细信息
4. 使用右上角图层控制器开关不同图层

## ❓ 常见问题

### 1. 安装相关问题

#### Q: GeoPandas安装失败怎么办？
**A**: GeoPandas依赖较复杂，建议：
```bash
# 方法1: 使用conda（推荐）
conda install -c conda-forge geopandas

# 方法2: 使用预编译包
pip install --find-links https://girder.github.io/large_image_wheels --no-index geopandas

# 方法3: Windows用户使用pipwin
pip install pipwin
pipwin install gdal fiona pyproj shapely
pip install geopandas
```

#### Q: GDAL库安装问题？
**A**: Windows用户：
1. 下载OSGeo4W安装器
2. 安装GDAL库
3. 设置环境变量
4. 重新安装GeoPandas

### 2. 使用相关问题

#### Q: 中文文件名显示乱码？
**A**: 工具已集成自动编码检测，如仍有问题：
1. 确保ZIP内包含.cpg文件
2. .cpg文件内容设置为"GBK"或"UTF-8"
3. 重新生成SHP文件时指定正确编码

#### Q: 坐标系转换失败？
**A**: 
1. 检查.prj文件是否存在且完整
2. 确认坐标系定义是否标准
3. 尝试在GIS软件中重新定义坐标系

#### Q: 地块位置检查失败？
**A**:
1. 确认Excel中的经纬度坐标正确
2. 检查坐标系是否匹配（度为单位 vs 米为单位）
3. 验证地块编码是否匹配

#### Q: 程序运行缓慢？
**A**:
1. 减少同时处理的文件数量
2. 关闭不必要的程序释放内存
3. 使用SSD硬盘提升IO性能

### 3. 文件格式问题

#### Q: ZIP文件无法解析？
**A**:
1. 确认ZIP文件未损坏
2. 检查文件路径是否包含特殊字符
3. 确保ZIP内SHP文件组完整

#### Q: Excel文件读取失败？
**A**:
1. 确认文件名为"地块信息.xlsx"
2. 检查必要列是否存在
3. 确认文件未被其他程序占用

### 4. 结果相关问题

#### Q: 生成的地图无法打开？
**A**:
1. 检查网络连接（需要加载在线地图）
2. 尝试使用不同浏览器打开
3. 检查HTML文件是否完整生成

#### Q: Excel结果乱码？
**A**:
1. 使用Excel 2016或更高版本打开
2. 尝试使用WPS Office打开
3. 检查系统区域设置

## 🔧 制作EXE文件

### 自动化构建（推荐）

#### 1. 使用构建脚本
```bash
# 运行自动构建脚本
python build_exe.py

# 或使用批处理文件（Windows）
build.bat
```

#### 2. 构建结果
- **dist/边界文件检查工具.exe**: 可执行文件
- **boundary_check.spec**: PyInstaller配置文件
- **build/**: 构建临时文件

### 手动构建

#### 1. 安装PyInstaller
```bash
pip install pyinstaller
```

#### 2. 基本打包命令
```bash
pyinstaller --onefile --windowed --name="边界文件检查工具" 边界文件检测工具V3.py
```

#### 3. 高级打包配置
```bash
# 使用spec文件打包（推荐）
pyinstaller boundary_check.spec

# 添加图标
pyinstaller --onefile --icon=icon.ico --name="边界文件检查工具" 边界文件检测工具V3.py

# 优化大小
pyinstaller --onefile --exclude-module matplotlib.tests --exclude-module numpy.tests 边界文件检测工具V3.py
```

### 分发说明

#### EXE文件使用
1. **无需Python环境**: 用户无需安装Python
2. **独立运行**: 包含所有必要依赖
3. **使用方法**: 
   - 将exe文件复制到工作目录
   - 准备好地块信息.xlsx和ZIP文件
   - 双击运行exe文件

#### 文件大小优化
- 典型大小: 150-300MB
- 优化方法: 排除测试模块、使用UPX压缩
- 首次运行可能较慢（解压临时文件）

## 📞 联系方式

### 技术支持
- **GitHub**: [HuangWuwutelling/boundary-check-tool](https://github.com/HuangWuwutelling/boundary-check-tool)
- **博客**: 黄五五讲故事的地方
- **邮箱**: 通过GitHub联系

### 问题反馈
如遇到问题，请提供以下信息：
1. 操作系统和Python版本
2. 错误信息截图
3. 示例数据文件（脱敏处理）
4. 详细的操作步骤

### 功能建议
欢迎提出新功能建议和改进意见！

---

**版本信息**: v3.0
**更新日期**: 2025-10-08
**作者**: HuangWuwutelling